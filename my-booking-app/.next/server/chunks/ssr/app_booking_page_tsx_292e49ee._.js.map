{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 7, "column": 0}, "map": {"version":3,"sources":["file://C%3A/Users/louai/Desktop/Louai/MO/my-booking-app/app/booking/page.tsx"],"sourcesContent":["'use client'\r\nimport { useAuth } from '@/context/AuthContext'\r\nimport { useRouter } from 'next/navigation'\r\nimport { useEffect, useMemo, useState } from 'react'\r\nimport { fetchServices, fetchStaff, fetchAllUsers, createBooking, fetchTimeslots } from '@/services/api'\r\nimport { TextField, MenuItem, Button, Snackbar, Alert } from '@mui/material'\r\n\r\ntype User = { _id: string; email: string; role: 'user' | 'staff' | 'admin'; name?: string }\r\ntype Service = { _id: string; title: string; duration?: number; price?: number }\r\ntype Staff = { _id: string; email: string; name?: string; skills?: (string | { _id: string })[] }\r\n\r\nexport default function BookingPage() {\r\n  const { user, token } = useAuth()\r\n  const router = useRouter()\r\n  const isPrivileged = user?.role === 'admin' || user?.role === 'staff'\r\n\r\n  const [services, setServices] = useState<Service[]>([])\r\n  const [staff, setStaff] = useState<Staff[]>([])\r\n  const [customers, setCustomers] = useState<User[]>([])\r\n\r\n  const [selectedServiceId, setSelectedServiceId] = useState('')\r\n  const [selectedStaffId, setSelectedStaffId] = useState('')\r\n  const [selectedCustomerId, setSelectedCustomerId] = useState('')\r\n  const [date, setDate] = useState<string>('')           // YYYY-MM-DD\r\n  const [slots, setSlots] = useState<string[]>([])       // ISO strings\r\n  const [slot, setSlot] = useState<string>('')           // chosen ISO\r\n\r\n  const [loading, setLoading] = useState(false)\r\n  const [toast, setToast] = useState<{open:boolean; msg:string; sev:'success'|'error'}>({open:false,msg:'',sev:'success'})\r\n\r\n  useEffect(() => { if (!user) router.push('/login') }, [user])\r\n\r\n  useEffect(() => {\r\n    (async () => {\r\n      try {\r\n        const [svc, stf] = await Promise.all([fetchServices(), fetchStaff()])\r\n        setServices(svc); setStaff(stf)\r\n        if (isPrivileged && token) {\r\n          const all = await fetchAllUsers(token)\r\n          setCustomers(all.filter((u:User)=>u.role==='user'))\r\n        }\r\n      } catch {\r\n        setToast({open:true, msg:'Fehler beim Laden der Daten', sev:'error'})\r\n      }\r\n    })()\r\n  }, [isPrivileged, token])\r\n\r\n  // Staff-Skill-Filter\r\n  const filteredStaff = useMemo(() => {\r\n    if (!selectedServiceId) return staff\r\n    return staff.filter(s =>\r\n      (s.skills ?? []).some((k:any) => (typeof k === 'string' ? k : k._id) === selectedServiceId)\r\n    )\r\n  }, [staff, selectedServiceId])\r\n\r\n  // Timeslots laden, sobald Service + Staff + Date gesetzt\r\n  useEffect(() => {\r\n    (async () => {\r\n      setSlots([]); setSlot('')\r\n      if (!token || !selectedServiceId || !selectedStaffId || !date) return\r\n      try {\r\n        const { slots: s } = await fetchTimeslots({ staffId: selectedStaffId, serviceId: selectedServiceId, date }, token)\r\n        setSlots(s)\r\n      } catch {\r\n        setToast({open:true, msg:'Fehler beim Laden der Zeit-Slots', sev:'error'})\r\n      }\r\n    })()\r\n  }, [token, selectedServiceId, selectedStaffId, date])\r\n\r\n  const handleBook = async () => {\r\n    if (!token) { setToast({open:true,msg:'Bitte logge dich ein',sev:'error'}); return }\r\n    if (!selectedServiceId || !selectedStaffId || !date || !slot || (isPrivileged && !selectedCustomerId)) {\r\n      setToast({open:true, msg:'Bitte alle Felder ausfüllen', sev:'error'}); return\r\n    }\r\n    try {\r\n      setLoading(true)\r\n      await createBooking(\r\n        selectedServiceId,\r\n        slot, // ISO vom Slot\r\n        selectedStaffId,\r\n        token,\r\n        isPrivileged ? selectedCustomerId : undefined\r\n      )\r\n      setToast({open:true, msg:'Termin gebucht', sev:'success'})\r\n      router.push('/dashboard')\r\n    } catch (e: any) {\r\n      const msg = e?.response?.data?.message || 'Buchung fehlgeschlagen'\r\n      setToast({open:true, msg, sev:'error'})\r\n    } finally { setLoading(false) }\r\n  }\r\n\r\n  return (\r\n    <div style={{ maxWidth: 560, margin: '24px auto' }}>\r\n      <h1>Termin buchen</h1>\r\n\r\n      {isPrivileged && (\r\n        <TextField select label=\"Kunde\" value={selectedCustomerId}\r\n          onChange={(e)=> setSelectedCustomerId(e.target.value)} fullWidth margin=\"normal\" required>\r\n          {customers.map(c => <MenuItem key={c._id} value={c._id}>{c.name ? `${c.name} – ${c.email}` : c.email}</MenuItem>)}\r\n        </TextField>\r\n      )}\r\n\r\n      <TextField select label=\"Service\" value={selectedServiceId}\r\n        onChange={(e)=> { setSelectedServiceId(e.target.value); setSelectedStaffId(''); setSlots([]); setSlot('') }}\r\n        fullWidth margin=\"normal\" required>\r\n        {services.map(s => <MenuItem key={s._id} value={s._id}>{s.title}</MenuItem>)}\r\n      </TextField>\r\n\r\n      <TextField select label=\"Mitarbeiter\" value={selectedStaffId}\r\n        onChange={(e)=> { setSelectedStaffId(e.target.value); setSlots([]); setSlot('') }}\r\n        fullWidth margin=\"normal\" required disabled={!selectedServiceId}\r\n        helperText={!selectedServiceId ? 'Bitte zuerst Service wählen' : undefined}>\r\n        {filteredStaff.map(s => <MenuItem key={s._id} value={s._id}>{s.name || s.email}</MenuItem>)}\r\n      </TextField>\r\n\r\n      <TextField type=\"date\" label=\"Datum\" value={date}\r\n        onChange={(e)=> setDate(e.target.value)} fullWidth margin=\"normal\"\r\n        InputLabelProps={{ shrink: true }} required />\r\n\r\n      <TextField select label=\"Zeit-Slot\" value={slot}\r\n        onChange={(e)=> setSlot(e.target.value)} fullWidth margin=\"normal\"\r\n        helperText={(!date || slots.length === 0) ? 'Keine freien Zeiten' : undefined}\r\n        disabled={!date || slots.length === 0} required>\r\n        {slots.map(sIso => {\r\n          const dt = new Date(sIso)\r\n          const label = dt.toLocaleTimeString('de-DE', { hour:'2-digit', minute:'2-digit' })\r\n          return <MenuItem key={sIso} value={sIso}>{label}</MenuItem>\r\n        })}\r\n      </TextField>\r\n\r\n      <Button variant=\"contained\" onClick={handleBook} disabled={\r\n        loading || !selectedServiceId || !selectedStaffId || !date || !slot || (isPrivileged && !selectedCustomerId)\r\n      } sx={{ mt: 2 }}>\r\n        Termin buchen\r\n      </Button>\r\n\r\n      <Snackbar open={toast.open} autoHideDuration={2200} onClose={() => setToast(p=>({...p, open:false}))}\r\n        anchorOrigin={{ vertical:'bottom', horizontal:'center' }}>\r\n        <Alert severity={toast.sev} variant=\"filled\" onClose={() => setToast(p=>({...p, open:false}))}>\r\n          {toast.msg}\r\n        </Alert>\r\n      </Snackbar>\r\n    </div>\r\n  )\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}